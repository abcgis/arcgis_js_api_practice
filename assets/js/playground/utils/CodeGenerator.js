/*! ArcGIS API for JavaScript 4.12 | Copyright (c) 2019 Esri. All rights reserved. | http://www.esri.com/legal/privacy | https://developers.arcgis.com/terms/faq */
define(["esri-playground-js/utils/ASTClasses"],function(ASTClasses){var _createNewDeclarationExpression=function(name,variable){var variableDeclaration=ASTClasses.getVariableDeclaration(ASTClasses.Kind.VAR);var variableDeclarator=ASTClasses.getVariableDeclarator();var newExpression=ASTClasses.getNewExpression();newExpression.callee=ASTClasses.getIdentifier(name);variableDeclarator.id=ASTClasses.getIdentifier(variable);variableDeclarator.init=newExpression;variableDeclaration.declarations.push(variableDeclarator);return variableDeclaration};var _createObjectDeclarationExpression=function(variable){var variableDeclaration=ASTClasses.getVariableDeclaration(ASTClasses.Kind.VAR);var variableDeclarator=ASTClasses.getVariableDeclarator();var objExpression=ASTClasses.getObjectExpression();variableDeclarator.id=ASTClasses.getIdentifier(variable);variableDeclarator.init=objExpression;variableDeclaration.declarations.push(variableDeclarator);return variableDeclaration};var _createExpressionStatement=function(idn_name,prop_name){var expressionStatement=ASTClasses.getExpressionStatement();var callExpression=ASTClasses.getCallExpression();var memberExpression=_createMemberExpression(idn_name,prop_name,false);callExpression.callee=memberExpression;expressionStatement.expression=callExpression;return expressionStatement};var _createMemberExpression=function(idn_name,prop_name,computed){var memberExpression=ASTClasses.getMemberExpression();var objectIdentifier=ASTClasses.getIdentifier(idn_name);var propertyIdentifier=ASTClasses.getIdentifier(prop_name);memberExpression.object=objectIdentifier;memberExpression.property=propertyIdentifier;memberExpression.computed=computed;return memberExpression};var _createNewExpression=function(idn_name){var newExpression=ASTClasses.getNewExpression();var objectIdentifier=ASTClasses.getIdentifier(idn_name);newExpression.callee=objectIdentifier;return newExpression};var _createUnaryExpression=function(value){var unaryExpression=ASTClasses.getUnaryExpression("-",true);var exp=ASTClasses.getLiteral(Math.abs(value));unaryExpression.argument=exp;return unaryExpression};var codeGenerator={};var getAST=function(name,variable){var program=ASTClasses.getProgram();program.body.push(_createNewDeclarationExpression(name,variable));return program};var getAutocastAST=function(variable,type,ast){var program=ASTClasses.getProgram();var objExpr=_createObjectDeclarationExpression(variable);var objExprProps=objExpr.declarations[0].init.properties;var propAST=ASTClasses.getProperty(ASTClasses.getIdentifier("type"),ASTClasses.getLiteral(type));objExprProps.push(propAST);var astArgs=ast.body[0].declarations[0].init.arguments;var astProps=astArgs&&astArgs[0]&&astArgs[0].properties;if(astProps){astProps.forEach(function(prop){if(prop.value.type==="ArrayExpression"){var arrayExp=ASTClasses.getArrayExpression();prop.value.elements.forEach(function(elem){if(elem.type==="NewExpression"&&elem._autocastType){var elemObjExp=ASTClasses.getObjectExpression();var elemAST=ASTClasses.getProperty(ASTClasses.getIdentifier("type"),ASTClasses.getLiteral(elem._autocastType));elemObjExp.properties.push(elemAST);var elemAstProps=elem.arguments&&elem.arguments[0]&&elem.arguments[0].properties;if(elemAstProps){elemAstProps.forEach(function(elemAstProp){elemObjExp.properties.push(elemAstProp)})}arrayExp.elements.push(elemObjExp)}else{arrayExp.elements.push(elem)}});var arrPropAST=ASTClasses.getProperty(ASTClasses.getIdentifier(prop.key.name),arrayExp);objExprProps.push(arrPropAST)}else{objExprProps.push(prop)}})}program.body.push(objExpr);return program};var constructAST=function(currentState){if(!currentState.ast){return}var ast=currentState.ast,config=currentState.config,obj=currentState.statefulObject,args=ast.body[0].declarations[0].init.arguments=[];config.properties.forEach(function(property){var propName=property["name"],value=obj[propName],propsAST;if(value!=null&&(value instanceof Object?!_isEmptyObj(value):true)){var valueAST=_getASTArg(property,value);if(valueAST){propsAST=ASTClasses.getProperty(ASTClasses.getIdentifier(propName),valueAST);if(args.length===0){args.push(ASTClasses.getObjectExpression())}args[0].properties.push(propsAST)}}});return ast};function _getASTArg(property,value){var arg,propertyType=property.type;if(propertyType==="Number"){if(value>=0){arg=ASTClasses.getLiteral(Number(value))}else{arg=_createUnaryExpression(Number(value))}return arg}else if(propertyType==="Boolean"){arg=ASTClasses.getLiteral(value);return arg}else if(propertyType==="String"){if(property.options&&property.options.type==="constants"){arg=_createMemberExpression(property.options.className,value,false);return arg}else{arg=ASTClasses.getLiteral(value);return arg}}else if(propertyType==="Color"){var arrayExp=ASTClasses.getArrayExpression();value.forEach(function(col){var literal=ASTClasses.getLiteral(col);arrayExp.elements.push(literal)});return arrayExp}else if(propertyType==="Object"){var objExp=ASTClasses.getObjectExpression();if(value instanceof Object){var objConfig=property["config"],properties=objConfig?objConfig["properties"]:property["properties"];properties.forEach(function(prop){var propName=prop["name"];if(value[propName]!=null){var astArg=_getASTArg(prop,value[propName]);if(astArg){var propAST=ASTClasses.getProperty(ASTClasses.getIdentifier(propName),astArg);objExp.properties.push(propAST)}}})}return objExp.properties.length&&objExp}else if(propertyType==="Array"){var arrayExp=ASTClasses.getArrayExpression();value.forEach(function(obj,idx){if(property["properties"][idx]){var item=_getASTArg(property["properties"][idx],obj);arrayExp.elements.push(item)}});return arrayExp.elements.length&&arrayExp||null}else if(propertyType==="Class"){arg=_createNewExpression(property.className||property.name);if(property.config.autocastType){arg._autocastType=property.config.autocastType}var properties=property.config.properties,objExp=ASTClasses.getObjectExpression();if(value instanceof Object){properties.forEach(function(prop){var propName=prop["name"];if(value[propName]!=null){var astArg=_getASTArg(prop,value[propName]);if(astArg){var propAST=ASTClasses.getProperty(ASTClasses.getIdentifier(propName),astArg);objExp.properties.push(propAST)}}})}objExp.properties.length&&arg.arguments.push(objExp);return arg}}function _isEmptyObj(obj){if(Array.isArray(obj)){if(!obj.length){return true}return false}var isEmpty=true;for(var prop in obj){if(obj.hasOwnProperty(prop)&&prop!=="_watchCallbacks"&&prop!=="className"){if(obj[prop]instanceof Object){isEmpty=_isEmptyObj(obj[prop])}else{if(obj[prop]!=null){isEmpty=false}}}}return isEmpty}var getProperty=function(data,className,propertyName){if(data["className"]!==className){for(var i=0;i<data["properties"].length;i++){var prop=data["properties"][i];if(className===prop["name"]){return prop}else if(prop["type"]==="Class"&&prop["className"]===className){if(getProperty(prop["config"],className,propertyName)){return prop}}else if(prop["type"]==="Array"){for(var j=0;j<prop["properties"].length;j++){var property=prop["properties"][j];if(getProperty(property["config"],className,propertyName)){return prop}}}}}else{for(var j=0;j<data["properties"].length;j++){var property=data["properties"][j];if(property["name"]===propertyName){return property}}}return false};var generateCode=function(ast){var code=escodegen.generate(ast,{format:{quotes:"double",compact:true}});return code};codeGenerator.getAST=getAST;codeGenerator.getAutocastAST=getAutocastAST;codeGenerator.constructAST=constructAST;codeGenerator.getProperty=getProperty;codeGenerator.generateCode=generateCode;return codeGenerator});